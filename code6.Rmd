```{r}
#necessary packages
if (!require("janitor")) install.packages("janitor")
if (!require("lubridate")) install.packages("lubridate")
if (!require("shiny")) install.packages("shiny")
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("palmerpenguins")) install.packages("palmerpenguins")
if (!require("DynNom")) install.packages("DynNom")
if (!require("shinydashboard")) install.packages("shinydashboard")
if (!require("DT")) install.packages("DT")
if (!require("viridis")) install.packages("viridis")


library(janitor)
library(lubridate)
library(tidyverse)
library(shiny)
library(palmerpenguins)
library(dplyr)
library(readr)
library(forcats)
library(ggplot2)
library(reshape2)
library(shinythemes)
library(DT)
library(shinydashboard)
library(viridis)

dig_df <- read.csv("DIG.csv")
data <- read.csv("DIG.csv")
# Convert columns to the most relevant data type
dig_df <- dig_df %>%
  mutate(
    ID = as.integer(ID),
    TRTMT = as.integer(TRTMT),
    AGE = as.integer(AGE),
    SEX = as.integer(SEX),
    BMI = as.numeric(BMI),
    KLEVEL = as.numeric(KLEVEL),
    CREAT = as.numeric(CREAT),
    DIABP = as.integer(DIABP),
    SYSBP = as.integer(SYSBP),
    HYPERTEN = as.integer(HYPERTEN),
    CVD = as.integer(CVD),
    WHF = as.integer(WHF),
    DIG = as.integer(DIG),
    HOSP = as.integer(HOSP),
    HOSPDAYS = as.integer(HOSPDAYS),
    DEATH = as.integer(DEATH),
    DEATHDAY = as.integer(DEATHDAY)
  )
dig_df$TRTMT <- factor(dig_df$TRTMT, levels = c(0, 1), labels = c("Placebo", "Treatment"))
dig_df$RACE <- factor(dig_df$RACE, levels = c(1, 2), labels = c("White", "Nonwhite"))
dig_df$SEX <- factor(dig_df$SEX, levels = c(1, 2), labels = c("Male", "Female"))
dig_df$HYPERTEN <- factor(dig_df$HYPERTEN, levels = c(0, 1), labels = c("No", "Yes"))
dig_df$CVD <- factor(dig_df$CVD, levels = c(0, 1), labels = c("No", "Yes"))
dig_df$DEATH <- factor(dig_df$DEATH, levels = c(0, 1), labels = c("Alive", "Death"))
dig_df$WHF <- factor(dig_df$WHF, levels = c(0, 1), labels = c("No", "Yes"))
dig_df$DIG <- factor(dig_df$DIG, levels = c(0, 1), labels = c("No", "Yes"))
dig_df$HOSP <- factor(dig_df$HOSP, levels = c(0, 1), labels = c("No", "Yes"))
print(dig_df)

dig_data <- dig_df



```




```{r}
# Function to label categorical variables
# 这些函数在处理特定列时使用
label_prevmi <- function(x) {
  ifelse(x == 1, "Previous MI", "No Previous MI")
}

label_diabetes <- function(x) {
  ifelse(x == 1, "Diabetes", "No Diabetes")
}

label_medication <- function(x) {
  ifelse(x == 0, "No Medication", "Medication Used")
}

label_nyha <- function(x) {
  factor(x, levels = c(1, 2, 3, 4), labels = c("Class I", "Class II", "Class III", "Class IV"))
}

# Define UI
ui <- dashboardPage(
  dashboardHeader(title = "DIG Data Analysis"),
  dashboardSidebar(
    radioButtons(inputId = "sex", label = "Select Patient Sex:", choices = c("All", "Male", "Female")),
    selectInput(inputId = "treatment_group", label = "Select Treatment Group:", choices = c("All", "Placebo", "Treatment"), multiple = FALSE),
    sliderInput("age_range", "Select Age Range:", min = 0, max = 100, value = c(20, 40)),
    checkboxGroupInput(inputId = "variables", label = "Select Variables to Display:", choices = c("AGE", "SEX", "BMI", "TRTMT"), selected = c("AGE", "SEX", "BMI", "TRTMT")),
    actionButton("refresh", "Refresh Data")
  ),
  dashboardBody(
    tabBox(
      width = 12,
      id = "tabs",
      tabPanel("Summary", 
               fluidRow(
                 box(width=12, 
                     title = "Treatment Summary", 
                     collapsible = TRUE, 
                     status = "primary", 
                     solidHeader = TRUE,
                     plotOutput("treatmentPlot")),
                 box(width=12,
                     title = "Baseline Characteristics", 
                     collapsible = TRUE, 
                     status = "primary", 
                     solidHeader = TRUE,
                     DTOutput("baselineTable"))
               )
      ),
      tabPanel("Plots", 
               fluidRow(
                 box(width=12, 
                     title = "Variable Distributions", 
                     collapsible = TRUE, 
                     status = "primary", 
                     solidHeader = TRUE,
                     plotOutput("distributionPlot")),
                 box(width=12, 
                     title = "Statistical Summary", 
                     collapsible = TRUE, 
                     status = "primary", 
                     solidHeader = TRUE,
                     verbatimTextOutput("statSummary"))
               )
      ),
      tabPanel("Boxplot Plot Analysis",
               fluidRow(
                 box(width = 12, status = "primary", solidHeader = TRUE,
                     selectInput("additionalPlotChoice", "Choose Boxplot Plot", choices = c(
                       "Ejection Fraction across NYHA Functional Class",
                       "BMI across Sex",
                       "Ejection Fraction across Race",
                       "Serum Creatinine across Previous MI",
                       "Serum Creatinine across Diabetes"
                     )),
                     plotOutput("selectedAdditionalPlot")
                 )
               )
      ),
      # tabPanel("Boxplot Plot Analysis",
      #          fluidRow(
      #            box(width = 12, status = "primary", solidHeader = TRUE,
      #                selectInput("additionalPlotChoice", "Choose Boxplot Plot", choices = c(
      #                  "Ejection Fraction across NYHA Functional Class",
      #                  "BMI across Sex",
      #                  "Ejection Fraction across Race",
      #                  "Serum Creatinine across Previous MI",
      #                  "Serum Creatinine across Diabetes"
      #                )),
      #                plotOutput("selectedAdditionalPlot")
      #            )
      #          )
      # ),      
      
      
    )
  )
)



# Server Definition
server <- function(input, output, session) {

dig_df <- read.csv("DIG.csv")
  # Reactive expression to filter the dataset
  filtered_data <- reactive({
    invalidateLater(10000, session)
    req(input$refresh)
    data <- dig_df
    if (input$sex != "All") {
      data <- data[data$SEX == ifelse(input$sex == "Male(1)", 1, 2), ]
    }
    if (input$treatment_group != "All") {
      data <- data[data$TRTMT == as.numeric(ifelse(input$treatment_group == "Treatment", 1, 0)), ]
    }
    data <- data[data$AGE >= input$age_range[1] & data$AGE <= input$age_range[2], ]
    return(data)
  })
  
  # Plot for treatment summary with colorful bars
  output$treatmentPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = as.factor(TRTMT), fill = as.factor(TRTMT))) +
      geom_bar() +
      scale_fill_viridis(discrete = TRUE, option = "D") +
      labs(title = "Treatment Summary", x = "Treatment Group", y = "Count") +
      theme_minimal()
  })
  
  # Table for baseline characteristics
  output$baselineTable <- renderDT({
    datatable(filtered_data() %>%
      select(all_of(input$variables)))
  })
  
  # Plot for variable distributions with colorful histograms
  output$distributionPlot <- renderPlot({
    if (length(input$variables) > 0) {
      ggplot(filtered_data(), aes_string(x = input$variables[1], fill = input$variables[1])) +
        geom_histogram(binwidth = 1) +
        scale_fill_viridis(discrete = TRUE) +
        labs(title = paste("Distribution of", input$variables[1])) +
        theme_minimal()
    }
  })
  
  # Statistical summary
  output$statSummary <- renderPrint({
    req(input$variables)
    summary(filtered_data()[, input$variables])
  })
  
  # Refresh action
  observeEvent(input$refresh, {
    # This can be used to trigger reactive expressions
  })
  
  
  # Additional plot logic
  output$selectedAdditionalPlot <- renderPlot({
    req(input$additionalPlotChoice)  # Ensure plot choice is selected
    selected_data <- dig_df  # Replace with appropriate filtered data if needed

    switch(input$additionalPlotChoice,
      "Ejection Fraction across NYHA Functional Class" = {
        selected_data$FUNCTCLS <- label_nyha(selected_data$FUNCTCLS)
        ggplot(selected_data, aes(x = FUNCTCLS, y = EJF_PER)) +
          geom_boxplot() +
          labs(x = "NYHA Functional Class", y = "Ejection Fraction", title = "Ejection Fraction across NYHA Functional Class")
      },
      "BMI across Sex" = {
        selected_data$SEX <- factor(selected_data$SEX, labels = c("Male", "Female"))
        ggplot(selected_data, aes(x = SEX, y = BMI)) +
          geom_boxplot() +
          labs(x = "Sex", y = "BMI", title = "BMI across Sex")
      },
      "Ejection Fraction across Race" = {
        selected_data$RACE <- factor(selected_data$RACE, labels = c("White", "Non-White"))
        ggplot(selected_data, aes(x = RACE, y = EJF_PER)) +
          geom_boxplot() +
          labs(x = "Race", y = "Ejection Fraction", title = "Ejection Fraction across Race")
      },  
      "Serum Creatinine across Previous MI" = {
        selected_data$PREVMI <- label_prevmi(selected_data$PREVMI)
        ggplot(selected_data, aes(x = PREVMI, y = CREAT)) +
          geom_boxplot() +
          labs(x = "Previous MI", y = "Serum Creatinine", title = "Serum Creatinine across Previous MI")
      },
      "Serum Creatinine across Diabetes" = {
        selected_data$SEX <- label_diabetes(selected_data$DIABETES)
        ggplot(selected_data, aes(x = DIABETES, y = CREAT)) +
          geom_boxplot() +
          labs(x = "Diabetes", y = "Serum Creatinine", title = "Serum Creatinine across Diabetes")
      }
                        
      
      
      # Add cases for other plot choices here
    )
  })
  
  
  
}

# Run the app
shinyApp(ui = ui, server = server)

```